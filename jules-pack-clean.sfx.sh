#!/usr/bin/env bash
set -euo pipefail
TARGET="${1:-.}"
echo "[SFX] Extracting Jules Just-Works Pack into: $TARGET"
mkdir -p "$TARGET"

write_file() {
  local dest="$1"; local b64="$2"
  if command -v python3 >/dev/null 2>&1; then
    python3 - "$dest" "$b64" <<'PYEOF'
import sys,base64,os
dest, data = sys.argv[1], sys.argv[2]
os.makedirs(os.path.dirname(dest), exist_ok=True) if os.path.dirname(dest) else None
with open(dest,'wb') as f: f.write(base64.b64decode(data))
print("[SFX] wrote", dest)
PYEOF
  else
    python - "$dest" "$b64" <<'PYEOF'
import sys,base64,os
dest, data = sys.argv[1], sys.argv[2]
os.makedirs(os.path.dirname(dest), exist_ok=True) if os.path.dirname(dest) else None
with open(dest,'wb') as f: f.write(base64.b64decode(data))
print("[SFX] wrote", dest)
PYEOF
  fi
}
write_file "$TARGET/.github/workflows/verify-docs.yml" "bmFtZTogdmVyaWZ5LWRvY3MKb246IFtwdXNoLCBwdWxsX3JlcXVlc3RdCmpvYnM6CiAgdmVyaWZ5OgogICAgcnVucy1vbjogdWJ1bnR1LWxhdGVzdAogICAgc3RlcHM6CiAgICAgIC0gdXNlczogYWN0aW9ucy9jaGVja291dEB2NAogICAgICAtIG5hbWU6IEp1bGVzIHByZWZsaWdodAogICAgICAgIHJ1bjogYmFzaCBzY3JpcHRzL2p1bGVzX3ByZWFtYmxlLnNoCiAgICAgIC0gbmFtZTogVmVyaWZ5IG1hbmlmZXN0CiAgICAgICAgcnVuOiBweXRob24gc2NyaXB0cy92ZXJpZnlfbWFuaWZlc3QucHkgLS1jaGVjawo="
write_file "$TARGET/README.md" "IyBKdWxlcyBKdXN0LVdvcmtzIFBhY2sKCi0gRXh0cmFjdCB0aGlzIGludG8geW91ciByZXBvIHJvb3Q6CiAgYGBgYmFzaAogIGJhc2gganVsZXMtcGFjay1jbGVhbi5zZnguc2ggLgogIGBgYAotIEF0IHRoZSB0b3Agb2YgRVZFUlkgSnVsZXMgdGFzaywgcGFzdGU6CiAgYGBgYmFzaAogIGJhc2ggc2NyaXB0cy9qdWxlc19wcmVhbWJsZS5zaAogIGBgYAo="
write_file "$TARGET/docs/AGENTS.md" "IyBBR0VOVFMubWQKClNlZSBwbGFuOyBzY2FmZm9sZCBhZ2VudHMgYXMgc3BlY2lmaWVkLgo="
write_file "$TARGET/docs/Agentic-Django-Plan.md" "IyBBZ2VudGljIERqYW5nbyBQbGFuIChKdWxlcy1TdHlsZSkKCj4gQWx3YXlzIHJ1bjoKPgo+IGBgYGJhc2gKPiBiYXNoIHNjcmlwdHMvanVsZXNfcHJlYW1ibGUuc2gKPiBgYGAK"
write_file "$TARGET/docs/manifest.yaml" "ewogICJyZXF1aXJlZCI6IFsKICAgIHsKICAgICAgInBhdGgiOiAiZG9jcy9BZ2VudGljLURqYW5nby1QbGFuLm1kIiwKICAgICAgInNoYTI1NiI6ICI1MTNhODBjZGI0MWQzNjViNjM3ZmQ3ODhkOWZlYzAyYjNmZTJhYmUyMTFiNTE2YjdmZjMyMmQxOWQyMWNmM2M4IgogICAgfSwKICAgIHsKICAgICAgInBhdGgiOiAiZG9jcy9BR0VOVFMubWQiLAogICAgICAic2hhMjU2IjogIjgyYzJiNzJlMTY4YmE3NWJhNzAyMzM2NWEyM2I0MDFiNjhiMmFhN2IwOTE2ZDQ5MWViNTQ4NTFkNmI1M2E5OWIiCiAgICB9LAogICAgewogICAgICAicGF0aCI6ICJzY3JpcHRzL2p1bGVzX3ByZWFtYmxlLnNoIiwKICAgICAgInNoYTI1NiI6ICI3M2U0ZTc1NGFhMGZlYWFmMTllNjY1MGFkNzZhZjY2ODc0ZTQ0ZDRjZTc1MjE5MTdlOWMwOGQ2YTJmNDdmYWE3IgogICAgfSwKICAgIHsKICAgICAgInBhdGgiOiAic2NyaXB0cy9yZXN0b3JlX2RvY3MucHkiLAogICAgICAic2hhMjU2IjogImM3YzI0NjdjN2EyZGVkOTk3ZDExZWY3YWRlMDFlMjJhYzcyMjVjODNjMmZmYTdiMzRiMTFmYjEyYjYwN2ZmNzAiCiAgICB9LAogICAgewogICAgICAicGF0aCI6ICJzY3JpcHRzL3ZlcmlmeV9tYW5pZmVzdC5weSIsCiAgICAgICJzaGEyNTYiOiAiZmVhMDk2ZWQ0YjIxNTYxNjJlNTVmNmNhNjMyMjBiOThkZmNkNTk2ZjFhNWExMmE4OTgyYTAwOGU3OWY1NzhhMCIKICAgIH0sCiAgICB7CiAgICAgICJwYXRoIjogIi5naXRodWIvd29ya2Zsb3dzL3ZlcmlmeS1kb2NzLnltbCIsCiAgICAgICJzaGEyNTYiOiAiZDUzMzIxNDQzMjFlNGU3MjAxNGYxYzUyZmU2MTI1Y2FjYjg1YzU1ZjkyYzZjMjFhNWZmMjE2ZjI4ZGMyZmNmZSIKICAgIH0sCiAgICB7CiAgICAgICJwYXRoIjogIlJFQURNRS5tZCIsCiAgICAgICJzaGEyNTYiOiAiYzY4ODMxZmRlODZkMDU5NmI1NDE5OGVlYTBiNTQ0OGE5MjdiMDNkZmY5ZmVlYmM5YWY0NmYxOTU3ZGUzODQ3NCIKICAgIH0KICBdCn0="
write_file "$TARGET/scripts/jules_preamble.sh" "IyEvdXNyL2Jpbi9lbnYgYmFzaApzZXQgLWV1byBwaXBlZmFpbApST09UPSIkKGdpdCByZXYtcGFyc2UgLS1zaG93LXRvcGxldmVsIDI+L2Rldi9udWxsIHx8IHB3ZCkiCmNkICIkUk9PVCIKbWtkaXIgLXAgZG9jcyBzY3JpcHRzIC5naXRodWIvd29ya2Zsb3dzCnB5dGhvbjMgc2NyaXB0cy9yZXN0b3JlX2RvY3MucHkgLS13cml0ZSBib3RoIDI+L2Rldi9udWxsIHx8IHB5dGhvbiBzY3JpcHRzL3Jlc3RvcmVfZG9jcy5weSAtLXdyaXRlIGJvdGgKcHl0aG9uMyBzY3JpcHRzL3ZlcmlmeV9tYW5pZmVzdC5weSAtLWNoZWNrIHx8IHB5dGhvbiBzY3JpcHRzL3ZlcmlmeV9tYW5pZmVzdC5weSAtLWNoZWNrCmVjaG8gIltqdWxlc10gcHJlZmxpZ2h0IE9LIgo="
write_file "$TARGET/scripts/restore_docs.py" "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwppbXBvcnQgYXJncGFyc2UsIGJhc2U2NApmcm9tIHBhdGhsaWIgaW1wb3J0IFBhdGgKUk9PVCA9IFBhdGgoX19maWxlX18pLnJlc29sdmUoKS5wYXJlbnRzWzFdCkRPQ1MgPSBST09UIC8gImRvY3MiCkRPQ1MubWtkaXIocGFyZW50cz1UcnVlLCBleGlzdF9vaz1UcnVlKQpQTEFOX0I2NCA9ICIiIkl5QkJaMlZ1ZEdsaklFUnFZVzVuYnlCUWJHRnVJQ2hLZFd4bGN5MVRkSGxzWlNrS0NqNGdRV3gzWVhseklISjFiam9LUGdvK0lHQmdZR0poYzJnS1BpQmlZWE5vSUhOamNtbHdkSE12YW5Wc1pYTmZjSEpsWVcxaWJHVXVjMmdLUGlCZ1lHQUsiIiIKQUdFTlRTX0I2NCA9ICIiIkl5QkJSMFZPVkZNdWJXUUtDbE5sWlNCd2JHRnVPeUJ6WTJGbVptOXNaQ0JoWjJWdWRITWdZWE1nYzNCbFkybG1hV1ZrTGdvPSIiIgoKZGVmIHdyaXRlX3BsYW4oKToKICAgIChET0NTIC8gIkFnZW50aWMtRGphbmdvLVBsYW4ubWQiKS53cml0ZV9ieXRlcyhiYXNlNjQuYjY0ZGVjb2RlKFBMQU5fQjY0KSkKCmRlZiB3cml0ZV9hZ2VudHMoKToKICAgIChET0NTIC8gIkFHRU5UUy5tZCIpLndyaXRlX2J5dGVzKGJhc2U2NC5iNjRkZWNvZGUoQUdFTlRTX0I2NCkpCgpkZWYgbWFpbigpOgogICAgd3JpdGVfcGxhbigpOyB3cml0ZV9hZ2VudHMoKTsgcHJpbnQoIltyZXN0b3JlX2RvY3NdIG9rIikKaWYgX19uYW1lX18gPT0gIl9fbWFpbl9fIjoKICAgIG1haW4oKQo="
write_file "$TARGET/scripts/verify_manifest.py" "IyEvdXNyL2Jpbi9lbnYgcHl0aG9uMwppbXBvcnQgc3lzLCBoYXNobGliLCBqc29uCmZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aApST09UID0gUGF0aChfX2ZpbGVfXykucmVzb2x2ZSgpLnBhcmVudHNbMV0KCmRlZiBzaGEyNTYocDogUGF0aCkgLT4gc3RyOgogICAgaCA9IGhhc2hsaWIuc2hhMjU2KCkKICAgIHdpdGggcC5vcGVuKCJyYiIpIGFzIGY6CiAgICAgICAgZm9yIGNodW5rIGluIGl0ZXIobGFtYmRhOiBmLnJlYWQoODE5MiksIGIiIik6CiAgICAgICAgICAgIGgudXBkYXRlKGNodW5rKQogICAgcmV0dXJuIGguaGV4ZGlnZXN0KCkKCmRlZiBsb2FkX21hbmlmZXN0KCkgLT4gZGljdDoKICAgIHAgPSBST09UIC8gImRvY3MiIC8gIm1hbmlmZXN0LnlhbWwiCiAgICBpZiBub3QgcC5leGlzdHMoKToKICAgICAgICByZXR1cm4geyJyZXF1aXJlZCI6WwogICAgICAgICAgICB7InBhdGgiOiJkb2NzL0FnZW50aWMtRGphbmdvLVBsYW4ubWQifSwKICAgICAgICAgICAgeyJwYXRoIjoiZG9jcy9BR0VOVFMubWQifSwKICAgICAgICAgICAgeyJwYXRoIjoic2NyaXB0cy9qdWxlc19wcmVhbWJsZS5zaCJ9LAogICAgICAgICAgICB7InBhdGgiOiJzY3JpcHRzL3Jlc3RvcmVfZG9jcy5weSJ9LAogICAgICAgICAgICB7InBhdGgiOiJzY3JpcHRzL3ZlcmlmeV9tYW5pZmVzdC5weSJ9LAogICAgICAgICAgICB7InBhdGgiOiIuZ2l0aHViL3dvcmtmbG93cy92ZXJpZnktZG9jcy55bWwifSwKICAgICAgICAgICAgeyJwYXRoIjoiUkVBRE1FLm1kIn0sCiAgICAgICAgXX0KICAgIHRyeToKICAgICAgICAjIG1hbmlmZXN0LnlhbWwgaXMgYWN0dWFsbHkgSlNPTiBmb3Igc3RkbGliLW9ubHkgcGFyc2luZwogICAgICAgIHJldHVybiBqc29uLmxvYWRzKHAucmVhZF90ZXh0KCkpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoIkZhaWxlZCB0byBwYXJzZSBtYW5pZmVzdDoiLCBlKQogICAgICAgIHN5cy5leGl0KDEpCgpkZWYgY2hlY2sobWFuaWZlc3Q6IGRpY3QpIC0+IGludDoKICAgIG1pc3NpbmcsIG1pc21hdGNoID0gW10sIFtdCiAgICBmb3IgaXRlbSBpbiBtYW5pZmVzdC5nZXQoInJlcXVpcmVkIiwgW10pOgogICAgICAgIHBhdGggPSBpdGVtWyJwYXRoIl07IHAgPSBST09UIC8gcGF0aAogICAgICAgIGlmIG5vdCBwLmV4aXN0cygpOiBtaXNzaW5nLmFwcGVuZChwYXRoKTsgY29udGludWUKICAgICAgICBleHBlY3QgPSBpdGVtLmdldCgic2hhMjU2IikKICAgICAgICBpZiBleHBlY3Q6CiAgICAgICAgICAgIGdvdCA9IHNoYTI1NihwKQogICAgICAgICAgICBpZiBnb3QgIT0gZXhwZWN0OiBtaXNtYXRjaC5hcHBlbmQoKHBhdGgsIGV4cGVjdCwgZ290KSkKICAgIGlmIG1pc3Npbmcgb3IgbWlzbWF0Y2g6CiAgICAgICAgaWYgbWlzc2luZzoKICAgICAgICAgICAgcHJpbnQoIk1pc3NpbmcgZmlsZXM6Iik7IFtwcmludCgiIC0iLCBtKSBmb3IgbSBpbiBtaXNzaW5nXQogICAgICAgIGlmIG1pc21hdGNoOgogICAgICAgICAgICBwcmludCgiQ2hlY2tzdW0gbWlzbWF0Y2hlczoiKQogICAgICAgICAgICBmb3IgcGF0aCwgZXhwLCBnb3QgaW4gbWlzbWF0Y2g6CiAgICAgICAgICAgICAgICBwcmludChmIiAtIHtwYXRofVxuICAgZXhwZWN0ZWQ6IHtleHB9XG4gICBnb3Q6ICAgICAge2dvdH0iKQogICAgICAgIHJldHVybiAxCiAgICBwcmludCgiTWFuaWZlc3QgT0siKTsgcmV0dXJuIDAKCmRlZiB1cGRhdGUobWFuaWZlc3Q6IGRpY3QpIC0+IGludDoKICAgIGNoYW5nZWQgPSBGYWxzZQogICAgZm9yIGl0ZW0gaW4gbWFuaWZlc3QuZ2V0KCJyZXF1aXJlZCIsIFtdKToKICAgICAgICBwID0gUk9PVCAvIGl0ZW1bInBhdGgiXQogICAgICAgIGlmIG5vdCBwLmV4aXN0cygpOiBjb250aW51ZQogICAgICAgIHMgPSBzaGEyNTYocCkKICAgICAgICBpZiBpdGVtLmdldCgic2hhMjU2IikgIT0gczoKICAgICAgICAgICAgaXRlbVsic2hhMjU2Il0gPSBzOyBjaGFuZ2VkID0gVHJ1ZQogICAgaWYgY2hhbmdlZDoKICAgICAgICBvdXQgPSBST09UIC8gImRvY3MiIC8gIm1hbmlmZXN0LnlhbWwiCiAgICAgICAgb3V0LndyaXRlX3RleHQoanNvbi5kdW1wcyhtYW5pZmVzdCwgaW5kZW50PTIpLCBlbmNvZGluZz0idXRmLTgiKQogICAgICAgIHByaW50KCJVcGRhdGVkIG1hbmlmZXN0IHdpdGggbmV3IGNoZWNrc3Vtcy4iKTsgcmV0dXJuIDAKICAgIHByaW50KCJObyB1cGRhdGVzIG5lZWRlZC4iKTsgcmV0dXJuIDAKCmlmIF9fbmFtZV9fID09ICJfX21haW5fXyI6CiAgICBpbXBvcnQgYXJncGFyc2UKICAgIGFwID0gYXJncGFyc2UuQXJndW1lbnRQYXJzZXIoKQogICAgYXAuYWRkX2FyZ3VtZW50KCItLWNoZWNrIiwgYWN0aW9uPSJzdG9yZV90cnVlIikKICAgIGFwLmFkZF9hcmd1bWVudCgiLS11cGRhdGUiLCBhY3Rpb249InN0b3JlX3RydWUiKQogICAgYXJncyA9IGFwLnBhcnNlX2FyZ3MoKQogICAgbWFuaWZlc3QgPSBsb2FkX21hbmlmZXN0KCkKICAgIGlmIGFyZ3MudXBkYXRlOiBzeXMuZXhpdCh1cGRhdGUobWFuaWZlc3QpKQogICAgc3lzLmV4aXQoY2hlY2sobWFuaWZlc3QpKQo="
# Self-verify checksums
if command -v python3 >/dev/null 2>&1; then PY=python3; else PY=python; fi
$PY "$TARGET/scripts/verify_manifest.py" --check || { echo "[SFX] ERROR: checksum verify failed"; exit 1; }
echo "[SFX] Done."
